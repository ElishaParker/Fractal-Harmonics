<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Device Audio Test</title>
<style>
body { background:#000; color:#0f0; font-family:monospace; text-align:center; }
#bar { width:300px; height:20px; border:1px solid #0f0; margin:20px auto; background:#111; }
#fill { height:100%; width:0%; background:#0f0; }
</style>
</head>
<body>
<h2>Speaker Output Test (via internal audio)</h2>
<audio id="player" src="assets/test.mp3" controls autoplay loop></audio>
<div id="bar"><div id="fill"></div></div>

<script>
const player = document.getElementById('player');
const fill = document.getElementById('fill');

player.addEventListener('play', async () => {
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const stream = player.captureStream(); // captures audio from this <audio> element
  const source = audioCtx.createMediaStreamSource(stream);
  const analyser = audioCtx.createAnalyser();
  analyser.fftSize = 256;
  const dataArray = new Uint8Array(analyser.frequencyBinCount);
  source.connect(analyser);

  function animate() {
    requestAnimationFrame(animate);
    analyser.getByteFrequencyData(dataArray);
    const avg = dataArray.reduce((a,b)=>a+b,0)/dataArray.length;
    fill.style.width = (avg/255*100).toFixed(1)+'%';
  }
  animate();
});
</script>
</body>
</html>
