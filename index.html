<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Audio Input Test</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #000;
      color: #0f0;
      font-family: monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #bar {
      width: 300px;
      height: 20px;
      background: #111;
      border: 1px solid #0f0;
      margin-top: 20px;
    }
    #fill {
      height: 100%;
      width: 0%;
      background: #0f0;
    }
  </style>
</head>
<body>
  <button id="startBtn" style="padding:10px 20px;font-size:16px;cursor:pointer;">ðŸŽ§ Start Audio Test</button>
  <div id="bar"><div id="fill"></div></div>

  <script>
    const startBtn = document.getElementById('startBtn');
    const fill = document.getElementById('fill');
    let audioCtx, analyser, dataArray;

    startBtn.addEventListener('click', async () => {
      try {
        // 1. Create context
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // 2. Generate a simple sine tone
        const osc = audioCtx.createOscillator();
        osc.frequency.value = 440; // A4
        const gain = audioCtx.createGain();
        gain.gain.value = 0.1;
        osc.connect(gain).connect(audioCtx.destination);
        osc.start();

        // 3. Get microphone input
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const mic = audioCtx.createMediaStreamSource(stream);

        // 4. Connect to analyser
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        mic.connect(analyser);

        // 5. Start drawing
        animate();
        startBtn.disabled = true;
        startBtn.innerText = "Audio Connected ðŸŽ¶";
      } catch (err) {
        console.error("Error:", err);
        alert("Audio initialization failed. Check mic permissions in browser.");
      }
    });

    function animate() {
      requestAnimationFrame(animate);
      if (!analyser) return;
      analyser.getByteFrequencyData(dataArray);
      let avg = dataArray.reduce((a,b)=>a+b,0)/dataArray.length;
      fill.style.width = (avg/255*100).toFixed(1) + '%';
    }
  </script>
</body>
</html>
